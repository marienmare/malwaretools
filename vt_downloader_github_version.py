#!/usr/bin/env python3

import requests
import hashlib
import sys
import os
import argparse
import pyminizip
from datetime import datetime


# !! you need put value in this variables
VT_KEY = 'VT_ENTERPRISE_API_KEY'
LOCAL_PATH = 'LOCALHOST_SAVE_PATH'

def vt_download(id):
    header = {
        "x-apikey": VT_KEY
    }
    url = f'https://www.virustotal.com/api/v3/files/{id}/download_url'
    resp = requests.get(url, headers=header)
    if resp.status_code == 200:
        jsonData = resp.json()
        file = requests.get(jsonData.get("data"))
        print(f"VirusTotal Download Link: {jsonData}\n")
        return file.content

def archive_file(file_name):
    return pyminizip.compress(file_name, None, file_name+".zip", "infected", 3)
    
def main():
    p = argparse.ArgumentParser()
    p.add_argument('hash')
    args = p.parse_args()
    
    # Sample download from VirusTotal
    sample = vt_download(args.hash)
    
    # Get Hash values
    md5 = hashlib.md5(sample).hexdigest()
    sha256 = hashlib.sha256(sample).hexdigest()
    
    # Save to local file path
    os.chdir(LOCAL_PATH)
    with open(sha256, "wb") as f:
        f.write(sample)
    
    # Compress and delete self
    pyminizip.compress(sha256, None, sha256+".zip", "infected", 3)
    os.remove(sha256)
        

if __name__ == '__main__':
    main()
